{% extends "layout.html" %}
{% load static %}
{% block title %}Mapshare{% endblock %}
{% block content%}
<p>{% if msg %}{{ msg }}{% endif %}</p>

<div style="position: relative;">
    <div id="map" style="height: 100%; width: 100%; position: fixed; z-index: -1;">
        <a href="https://www.maptiler.com">
            <img src="https://api.maptiler.com/resources/logo.svg" alt="MapTiler logo">
        </a>
    </div>
    <div class=""
        id="legend-cnt"
        style="box-sizing: border-box; position: fixed; z-index: 999; justify-content: space-between; color: white; background-color: #3c3c3c; padding: 10px; bottom: 0; left: 0;"
    >
        <h2 id="mapcode-text" style=" font-size: 2.5rem;"><small>{{ context }}</small> {{ mapcode }}</h2> <p id="territory">Territory: {{ territory }}</p>
    </div>
</div>


<div class="fixed-action-btn">
    <a class="btn-floating btn-large blue" title="click to copy share link">
        <i class="large material-icons">menu</i>
    </a>
    <ul>
        <li><a class="btn-floating blue btn modal-trigger tooltipped" id="info-link" data-position="left" data-tooltip="More info on Mapcodes"><i class="material-icons">info</i></a></li>
        <li><a class="btn-floating blue btn modal-trigger tooltipped" id="share-link" data-position="left" data-tooltip="Click to copy share link"><i class="material-icons">link</i></a></li>
    </ul>
</div>

<script type="text/javascript">
    const key = "{{ maptilerAPIKey }}";
    const urlLat = {{ urlLat }};
    const urlLng = {{ urlLng }};
    const tileLayer = "https://api.maptiler.com/maps/openstreetmap/{z}/{x}/{y}.jpg";
    const map = L.map('map')
        .setView([urlLat, urlLng], {{initialZoom}}); //starting position
    const isValidMapcode = "{{ isValidMapcode }}" == "True";
    var marker;

    L.tileLayer(`${tileLayer}?key=${key}`,{
      tileSize: 512,
      zoomOffset: -1,
      minZoom: 1,
      attribution: "\u003ca href=\"https://www.maptiler.com/copyright/\" target=\"_blank\"\u003e\u0026copy; MapTiler\u003c/a\u003e \u003ca href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\"\u003e\u0026copy; OpenStreetMap contributors\u003c/a\u003e",
      crossOrigin: true
    }).addTo(map);

    if (isValidMapcode) {
        marker = L.marker([urlLat, urlLng]).addTo(map);
    }

    map.on("click", function(e) {
        // Add marker to map on click
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        const contextText = document.getElementById("context-text");
        const mapcodeText = document.getElementById("mapcode-text");
        const territoryText = document.getElementById("territory");

        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng], {draggable: true}).addTo(map);

        fetch("/getMapcodeAJAX", {
            method: "POST",
            credentials: "same-origin",
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                lat: lat,
                lng: lng
            })
        })
        .then(response => response.json())
        .then(data => {
            const success = data.success == "true";
            const url = window.location.origin;
            let content = "Mapcode for this location not available";
            let territory = "Territory: International";
            delete data.success
            if (success) {
                console.log(data);
                content = "";
                data.mapcodes.forEach(result => {
                    content += `<small>${result.context}</small> ${result.mapcode}<br>`;
                    window.history.pushState({}, "", `/${result.context}/${result.mapcode}`);
                    // TODO: At the moment it's only using the last one (AAA) update this to use the first one
                    territory = `Territory: ${result.territory}`;
                });
                mapcodeText.innerHTML = content;
                territoryText.innerHTML = territory;
            } else {
                M.toast({html: "No valid mapcode found"});
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function() {
        const actionButtons = document.querySelectorAll(".fixed-action-btn");
        const actionButtonInstances = M.FloatingActionButton.init(actionButtons, {});
        const tooltips = document.querySelectorAll(".tooltipped");
        const tooltipInstances = M.Tooltip.init(tooltips, {});
        const sharelinkElem = document.getElementById("share-link");
        let sharelink = "/{{ context }}/{{ mapcode }}";

        sharelinkElem.addEventListener("click", function() {
            // Copies link to clipboard
            navigator.clipboard.writeText(window.location.href);
            M.toast({html: "Share link copied to clipboard!", classes: "rounded"});
        });
    });

    // TODO: Implement Geoapify for autosuggest
    
</script>

{% endblock %}