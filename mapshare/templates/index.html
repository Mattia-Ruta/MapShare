{% extends "layout.html" %}
{% load static %}
{% block title %}Mapshare | Location in {{ territory }} {% endblock %}
{% block content%}

<!-- Mapcode Info Box class="fixed-bottom" -->
<div class="card fixed-bottom" style="bottom: 1%; left: 1%; width: 92%; background-color: #444444; z-index: 999;">
    <div class="card-body">
        <button id="copyBtn" type="button" class="btn btn-outline-info btn-lg m-1" style="display: inline;">
            <span id="countryFlag">{% if countryFlag %}{{ countryFlag }}{% endif %}</span>
            <h3 id="contextText" style="display: inline; color: white;">
                {{ context }}
            </h3>&nbsp
            <h2 id="mapcodeText" style="display: inline; color: white" title="This code represents this exact location!">
                {{ mapcode }}
            </h2>&nbsp
            <i class="fa-solid fa-copy"></i>
        </button>
        {% comment %} <form style="display: inline-block">
                <input id="searchInput" class="form-control p-2 m-1" type="text" placeholder="Enter Mapcode or address" aria-label="Enter Mapcode input">
        </form> {% endcomment %}
    </div>
    <!-- Territory Area -->
    <div class="card-footer text-muted">
            <div class="dropup">
                <button class="btn btn-outline-info btn-md m-1 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="territoryCnt">
                    <i class="fa-solid fa-mountain-sun"></i> Territory: <strong id="territory">{{ territory }}</strong>
                </button>
                <!-- Alternative Mapcodes Dropdown -->
                <ul id="altMapcodesDropdown" class="dropdown-menu">
                    {% for altMapcode in altMapcodes %}
                        <li><a class="dropdown-item{% if altMapcode.mapcode == mapcode %} active{% endif %}" href="/{{ altMapcode.context}}/{{ altMapcode.mapcode}}"{% if altMapcode.mapcode == mapcode %} aria-current="true"{% endif %}>{{ altMapcode.countryFlag }} [{{ altMapcode.context }} {{ altMapcode.mapcode }}] <small><i>{{ altMapcode.territory }}</i></small></a></li>
                    {% endfor %}
                </ul>
            </div>
    </div>
</div>

<!-- Top-Right Buttons -->
<div class="container-sm mt-5 me-5 gap-5" style="position: absolute; right: 2%;">
    <div class="row justify-content-end">
        <div class="col-1">
            <button id="locationBtn" type="button" class="btn btn-info btn-lg" title="Click to get mapcode for your current location" style="padding-right: 1.2em; padding-left: 1.2em;"><i class="fa-solid fa-location-arrow"></i></button>
        </div>
    </div>
    <div class="row justify-content-end mt-1">
        <div class="col-1">
            <button id="shareBtn" type="button" class="btn btn-info btn-lg" title="Click to share!" style="padding-right: 1.2em; padding-left: 1.2em;"><i class="fa-solid fa-share-nodes"></i></button>
        </div>
    </div>
    <div class="row justify-content-end mt-1">
        <div class="col-1">
            <button id="googleMapsBtn" type="button" class="btn btn-info btn-lg" title="Open in Google Maps"><img src="{% static 'img/google-maps.png' %}" style="max-width: 1.6em; height: auto;"></button>
        </div>
    </div>
</div>

<!-- Alert -->
<div id="alert-container" class="container-med">
    {% if msg %}
        <div class="container"><div class="alert alert-info alert-dismissible" role="alert" style="margin-top: 4em;"><div>{{ msg }}</div><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div></div>
    {% elif error %}
        <div class="container"><div class="alert alert-danger alert-dismissible" role="alert" style="margin-top: 4em;"><div>{{ error }}</div><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div></div>
    {% endif %}
</div>

<!-- Map -->
<div id="map" style="position: absolute; top: 0; bottom: 0; height: 100%; width: 100%; margin: 0; padding: 0; z-index: -5;">

</div>

<script type="text/javascript">
    const msg = "{{ msg }}";
    const error = "{{ error }}";
    const key = "{{ mapboxAPIKey }}";
    const debug = "{{ debug }}" == "True";
    const lookupData = {
        country: "{{ lookupCountry }}",
        countryCode: "{{ lookupCountryCode }}",
        context: "{{ lookupContext }}",
        region: "{{ lookupRegion }}",
        city: "{{ lookupCity }}",
        lat: {{ lookupLat }},
        lng: {{ lookupLng }}
    };
    if (debug) console.log("Initial Lookup Data: ", lookupData);
    
    // Sanitise URL params and alert if not correct
    const pathArray = window.location.pathname.split("/").filter(n => n);
    const defaultCoords = {lat: lookupData.lat, lng: lookupData.lng};
    const defaultMapcode = {context: "{{ context }}", mapcode: "{{ mapcode }}"};
    const precision = 0;    // Default for easy mapcodes, higher number means more letters in mapcode. Don't forget to set in precision text element as well!
    let isFreshRequest = false;
    let response;
    let currentMarker;
    const territoryElem = document.getElementById("territory");
    const spinningGif = `<img height="35px" width="35px" src="{% static 'img/spinning.gif' %}"></img>`;
    const csrfToken = "{{ csrf_token }}";

    let mapcode = "{{ mapcode }}";
    let altMapcodes = {{ altMapcodes|safe }};
    let context = "{{ context }}";
    let territory = "{{ territory }}";
    let coords = {lat: "{{ urlLat }}", lng: "{{ urlLng }}"};
    const initialZoom = {{ initialZoom }};
</script>
<script type="text/javascript" src="{% static 'js/index.js' %}"></script>

{% endblock %}